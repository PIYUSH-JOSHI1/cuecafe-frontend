<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Your Slot - Cue Stories</title>
  <link rel="stylesheet" href="../styles/main.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      background-color: #1a1a1a;
      color: #fff;
    }
    .booking-container {
      padding: 40px 20px;
      max-width: 1000px;
      margin: 0 auto;
    }
    .header {
      text-align: center;
      margin-bottom: 40px;
    }
    .header h1 {
      color: #ffc107;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 40px;
      position: relative;
    }
    .step-indicator::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 5%;
      right: 5%;
      height: 2px;
      background-color: #444;
      z-index: 0;
    }
    .step-item {
      position: relative;
      z-index: 1;
      flex: 1;
      text-align: center;
    }
    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #444;
      margin: 0 auto 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .step-circle.active {
      background-color: #ffc107;
      color: #000;
      box-shadow: 0 0 15px rgba(255, 193, 7, 0.5);
    }
    .step-circle.completed {
      background-color: #4CAF50;
    }
    .step-label {
      font-size: 0.9rem;
      color: #a0a0a0;
    }
    .booking-step {
      display: none;
    }
    .booking-step.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .games-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .game-card {
      background-color: #2d2d2d;
      border: 3px solid #444;
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .game-card:hover {
      border-color: #ffc107;
      transform: translateY(-5px);
    }
    .game-card.selected {
      background-color: rgba(255, 193, 7, 0.1);
      border-color: #ffc107;
      box-shadow: 0 0 20px rgba(255, 193, 7, 0.4);
    }
    .game-icon {
      font-size: 3rem;
      color: #ffc107;
      margin-bottom: 15px;
    }
    .game-name {
      font-size: 1.3rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 10px;
    }
    .game-price {
      color: #ffc107;
      font-size: 1.1rem;
      font-weight: 600;
    }
    .date-time-section {
      background-color: #2d2d2d;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
    }
    .date-picker {
      margin-bottom: 25px;
    }
    .date-picker label {
      display: block;
      margin-bottom: 10px;
      color: #ffc107;
      font-weight: 600;
    }
    .date-picker input {
      width: 100%;
      padding: 12px;
      background-color: #1a1a1a;
      border: 2px solid #444;
      border-radius: 8px;
      color: #fff;
      font-size: 1rem;
    }
    .date-picker input:focus {
      border-color: #ffc107;
      outline: none;
      box-shadow: 0 0 10px rgba(255, 193, 7, 0.3);
    }
    .time-slots {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 10px;
    }
    .time-slot {
      padding: 12px;
      background-color: #1a1a1a;
      border: 2px solid #444;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }
    .time-slot:hover:not(.disabled) {
      border-color: #ffc107;
      transform: translateY(-2px);
    }
    .time-slot.selected {
      background-color: #ffc107;
      color: #000;
      border-color: #ffc107;
      font-weight: 600;
    }
    .time-slot.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      color: #666;
    }
    .confirmation-section {
      background-color: #2d2d2d;
      padding: 30px;
      border-radius: 12px;
      border: 2px solid #ffc107;
    }
    .confirmation-item {
      display: flex;
      justify-content: space-between;
      padding: 15px 0;
      border-bottom: 1px solid #444;
    }
    .confirmation-item:last-child {
      border-bottom: none;
    }
    .confirmation-item .label {
      color: #a0a0a0;
    }
    .confirmation-item .value {
      color: #ffc107;
      font-weight: 600;
    }
    .price-breakdown {
      background-color: #1a1a1a;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }
    .price-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #444;
    }
    .price-row:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
      font-weight: 600;
      font-size: 1.1rem;
      color: #4CAF50;
    }
    .action-buttons {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }
    .btn-action {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1rem;
    }
    .btn-next {
      background-color: #ffc107;
      color: #000;
    }
    .btn-next:hover:not(:disabled) {
      background-color: #ffb300;
      box-shadow: 0 0 15px rgba(255, 193, 7, 0.5);
    }
    .btn-back {
      background-color: #444;
      color: #fff;
    }
    .btn-back:hover {
      background-color: #555;
    }
    .btn-action:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .loading {
      text-align: center;
      padding: 40px;
    }
    .spinner {
      border: 4px solid #444;
      border-top: 4px solid #ffc107;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error-box {
      background-color: rgba(244, 67, 54, 0.1);
      border: 2px solid #f44336;
      color: #ff6b6b;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="booking-container">
    <!-- Header -->
    <div class="header">
      <h1><i class="fas fa-cue" style="margin-right: 10px;"></i>Book Your Slot</h1>
      <p class="text-muted">Cue Stories - Premium Snooker & Foosball</p>
    </div>

    <!-- Step Indicator -->
    <div class="step-indicator">
      <div class="step-item">
        <div class="step-circle active" id="step1Circle">1</div>
        <div class="step-label">Select Game</div>
      </div>
      <div class="step-item">
        <div class="step-circle" id="step2Circle">2</div>
        <div class="step-label">Choose Date & Time</div>
      </div>
      <div class="step-item">
        <div class="step-circle" id="step3Circle">3</div>
        <div class="step-label">Confirm Booking</div>
      </div>
      <div class="step-item">
        <div class="step-circle" id="step4Circle">4</div>
        <div class="step-label">Payment</div>
      </div>
    </div>

    <!-- Error Box -->
    <div class="error-box" id="errorBox"></div>

    <!-- STEP 1: Select Game -->
    <div class="booking-step active" id="step1">
      <h3 style="color: #ffc107; margin-bottom: 30px;">Step 1: Select a Game</h3>
      <div class="loading" id="gamesLoading" style="display: none;">
        <div class="spinner"></div>
        <p>Loading available games...</p>
      </div>
      <div class="games-grid" id="gamesGrid">
        <!-- Games will be loaded here -->
      </div>
      <div class="action-buttons">
        <button class="btn-action btn-next" id="nextStep1" disabled onclick="goToStep(2)">
          Next: Choose Date & Time
        </button>
      </div>
    </div>

    <!-- STEP 2: Select Date & Time -->
    <div class="booking-step" id="step2">
      <h3 style="color: #ffc107; margin-bottom: 30px;">Step 2: Choose Date & Time</h3>
      <div class="date-time-section">
        <div class="date-picker">
          <label for="bookingDate">Select Date</label>
          <input type="date" id="bookingDate" required>
        </div>

        <div>
          <label style="display: block; color: #ffc107; font-weight: 600; margin-bottom: 15px;">Available Time Slots</label>
          <div class="loading" id="slotsLoading" style="display: none;">
            <p>Loading available slots...</p>
          </div>
          <div class="time-slots" id="timeSlotsContainer">
            <!-- Time slots will be loaded here -->
          </div>
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn-action btn-back" onclick="goToStep(1)">Back</button>
        <button class="btn-action btn-next" id="nextStep2" disabled onclick="goToStep(3)">
          Next: Confirm Booking
        </button>
      </div>
    </div>

    <!-- STEP 3: Confirm Booking -->
    <div class="booking-step" id="step3">
      <h3 style="color: #ffc107; margin-bottom: 30px;">Step 3: Confirm Your Booking</h3>
      <div class="confirmation-section" id="confirmationDetails">
        <!-- Confirmation details will be shown here -->
      </div>

      <div class="action-buttons">
        <button class="btn-action btn-back" onclick="goToStep(2)">Back</button>
        <button class="btn-action btn-next" id="nextStep3" onclick="goToStep(4)">
          Proceed to Payment
        </button>
      </div>
    </div>

    <!-- STEP 4: Payment -->
    <div class="booking-step" id="step4">
      <h3 style="color: #ffc107; margin-bottom: 30px;">Step 4: Complete Payment</h3>
      <div class="confirmation-section">
        <div id="paymentSummary">
          <!-- Payment summary will be shown here -->
        </div>
        <button class="btn-action btn-next" style="margin-top: 30px; width: 100%;" id="paymentBtn" onclick="initiatePayment()">
          Pay with Razorpay
        </button>
      </div>

      <div class="action-buttons" style="margin-top: 20px;">
        <button class="btn-action btn-back" onclick="goToStep(3)">Back</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  
  <!-- Inline Supabase config and managers -->
  <script>
    const SUPABASE_URL = 'https://dtmjfodtpbjutrebgzzl.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR0bWpmb2R0cGJqdXRyZWJnenpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMzQ3MzcsImV4cCI6MjA4NDkxMDczN30.r5NooTQnkfDa5kj4NSsNzgUZlTdyxnaY2bH9CaegyK0';

    // Auth Manager
    class AuthManager {
      constructor() {
        this.currentUser = this.loadFromLocalStorage();
      }
      loadFromLocalStorage() {
        const stored = localStorage.getItem('cue_user');
        if (stored) {
          try { return JSON.parse(stored); } catch (e) { return null; }
        }
        return null;
      }
      isLoggedIn() { return this.currentUser !== null; }
      getCurrentUser() { return this.currentUser; }
      showNotification(message, type = 'success') {
        alert(message);
      }
      requireLogin() {
        window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname);
        return false;
      }
    }
    const authManager = new AuthManager();

    // Booking Manager
    class BookingManager {
      constructor() {
        this.selectedGame = null;
        this.selectedDate = null;
        this.availableSlots = [];
        console.log('[v0] BookingManager initialized');
      }

      async getAllGames() {
        try {
          console.log('[v0] Fetching all games');
          const response = await fetch(
            `${SUPABASE_URL}/rest/v1/games?select=*`,
            {
              headers: {
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'apikey': SUPABASE_ANON_KEY,
              },
            }
          );
          if (!response.ok) {
            console.error('[v0] Error response:', await response.text());
            return [];
          }
          const games = await response.json();
          console.log('[v0] Games fetched:', games);
          return games || [];
        } catch (error) {
          console.error('[v0] Error fetching games:', error);
          return [];
        }
      }

      async getAvailableSlots(gameId, date) {
        try {
          // Fetch all non-cancelled bookings (confirmed and pending)
          const response = await fetch(
            `${SUPABASE_URL}/rest/v1/bookings?game_id=eq.${gameId}&booking_date=eq.${date}&status=neq.cancelled`,
            {
              headers: {
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'apikey': SUPABASE_ANON_KEY,
              },
            }
          );
          const bookings = await response.json();
          const bookedTimes = new Set();
          bookings.forEach((b) => bookedTimes.add(`${b.start_time}-${b.end_time}`));
          
          const slots = [];
          for (let hour = 9; hour < 23; hour++) {
            const startTime = `${String(hour).padStart(2, '0')}:00`;
            const endTime = `${String(hour + 1).padStart(2, '0')}:00`;
            const timeKey = `${startTime}-${endTime}`;
            slots.push({ startTime, endTime, available: !bookedTimes.has(timeKey), timeKey });
          }
          return slots;
        } catch (error) {
          console.error('[v0] Error fetching slots:', error);
          return [];
        }
      }

      async createBooking(gameId, date, startTime, endTime) {
        try {
          console.log('[v0] Creating booking');
          
          if (!authManager.isLoggedIn()) {
            authManager.showNotification('Please login first', 'error');
            authManager.requireLogin();
            return null;
          }

          const user = authManager.getCurrentUser();
          
          // Fetch game details for pricing
          const gamesResponse = await fetch(
            `${SUPABASE_URL}/rest/v1/games?id=eq.${gameId}`,
            {
              headers: {
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'apikey': SUPABASE_ANON_KEY,
              },
            }
          );
          const games = await gamesResponse.json();
          if (games.length === 0) {
            authManager.showNotification('Game not found', 'error');
            return null;
          }

          const game = games[0];
          const basePrice = game.price_per_hour;
          const discount = game.first_booking_discount || 0;
          const totalPrice = basePrice - discount;

          // Create booking in Supabase
          const bookingResponse = await fetch(
            `${SUPABASE_URL}/rest/v1/bookings`,
            {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'apikey': SUPABASE_ANON_KEY,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation',
              },
              body: JSON.stringify({
                user_id: user.id,
                venue_id: game.venue_id,
                game_id: gameId,
                booking_date: date,
                start_time: startTime,
                end_time: endTime,
                total_price: totalPrice,
                discount_applied: discount,
                payment_status: 'pending',
                status: 'pending',
              }),
            }
          );

          if (!bookingResponse.ok) {
            const error = await bookingResponse.json();
            console.error('[v0] Booking creation error:', error);
            authManager.showNotification('Failed to create booking', 'error');
            return null;
          }

          const bookingData = await bookingResponse.json();
          const booking = Array.isArray(bookingData) ? bookingData[0] : bookingData;
          console.log('[v0] Booking created:', booking);

          return {
            id: booking.id,
            price: totalPrice,
            game: game.name,
            date,
            time: `${startTime} - ${endTime}`,
          };
        } catch (error) {
          console.error('[v0] Error creating booking:', error);
          authManager.showNotification('Booking creation failed', 'error');
          return null;
        }
      }
    }
    const bookingManager = new BookingManager();
  </script>

  <script>
    console.log("[v0] Booking page loaded");

    // Booking state
    const bookingState = {
      selectedGame: null,
      selectedDate: null,
      selectedTime: null,
      selectedTimeSlot: null,
      games: [],
      slots: []
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      console.log("[v0] DOM Content Loaded - initializing booking page");
      
      // Check user is logged in
      if (!authManager.isLoggedIn()) {
        console.log("[v0] User not logged in - redirecting to login");
        window.location.href = '/pages/login.html?redirect=' + encodeURIComponent(window.location.pathname);
        return;
      }

      // Load games
      await loadGames();
      
      // Set min date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('bookingDate').min = today;
      document.getElementById('bookingDate').value = today;

      // Add date change listener
      document.getElementById('bookingDate').addEventListener('change', (e) => {
        bookingState.selectedDate = e.target.value;
        bookingState.selectedTime = null;
        bookingState.selectedTimeSlot = null;
        loadTimeSlots();
      });

      // Load initial slots for today
      bookingState.selectedDate = today;
      await loadTimeSlots();
    });

    // Load games
    async function loadGames() {
      try {
        console.log("[v0] Loading games...");
        document.getElementById('gamesLoading').style.display = 'block';
        
        const games = await bookingManager.getAllGames();
        console.log("[v0] Games loaded:", games);
        bookingState.games = games;

        const gamesGrid = document.getElementById('gamesGrid');
        gamesGrid.innerHTML = '';

        if (!games || games.length === 0) {
          console.warn("[v0] No games returned from API");
          gamesGrid.innerHTML = '<div class="text-warning">No games available. Please contact support.</div>';
          document.getElementById('gamesLoading').style.display = 'none';
          return;
        }

        games.forEach(game => {
          const gameCard = document.createElement('div');
          gameCard.className = 'game-card';
          gameCard.onclick = () => selectGame(game);
          
          const icon = game.name === 'Snooker' ? 'fa-circle-o' : 'fa-futbol';
          gameCard.innerHTML = `
            <div class="game-icon">
              <i class="fas ${icon}"></i>
            </div>
            <div class="game-name">${game.name}</div>
            <div class="game-price">₹${game.price_per_hour}/hour</div>
          `;
          gamesGrid.appendChild(gameCard);
        });

        document.getElementById('gamesLoading').style.display = 'none';
      } catch (error) {
        console.error("[v0] Error loading games:", error);
        showError('Failed to load games. Please refresh the page.');
        document.getElementById('gamesLoading').style.display = 'none';
      }
    }

    // Select game
    function selectGame(game) {
      console.log("[v0] Game selected:", game.name);
      bookingState.selectedGame = game;

      // Update UI
      document.querySelectorAll('.game-card').forEach(card => {
        card.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');

      // Enable next button
      document.getElementById('nextStep1').disabled = false;

      // Update step indicator
      updateStepIndicator();
    }

    // Load time slots
    async function loadTimeSlots() {
      try {
        if (!bookingState.selectedGame) {
          console.log("[v0] No game selected yet");
          return;
        }

        console.log("[v0] Loading time slots for game:", bookingState.selectedGame.id);
        document.getElementById('slotsLoading').style.display = 'block';

        const slots = await bookingManager.getAvailableSlots(
          bookingState.selectedGame.id,
          bookingState.selectedDate
        );
        console.log("[v0] Time slots loaded:", slots);
        bookingState.slots = slots;

        const container = document.getElementById('timeSlotsContainer');
        container.innerHTML = '';

        slots.forEach(slot => {
          const slotBtn = document.createElement('button');
          slotBtn.className = `time-slot ${!slot.available ? 'disabled' : ''}`;
          slotBtn.textContent = slot.startTime;
          slotBtn.type = 'button';
          slotBtn.disabled = !slot.available;

          if (slot.available) {
            slotBtn.onclick = () => selectTimeSlot(slot);
          }

          container.appendChild(slotBtn);
        });

        document.getElementById('slotsLoading').style.display = 'none';
      } catch (error) {
        console.error("[v0] Error loading time slots:", error);
        showError('Failed to load time slots.');
        document.getElementById('slotsLoading').style.display = 'none';
      }
    }

    // Select time slot
    function selectTimeSlot(slot) {
      console.log("[v0] Time slot selected:", slot.timeKey);
      bookingState.selectedTimeSlot = slot;
      bookingState.selectedTime = slot.startTime;

      // Update UI
      document.querySelectorAll('.time-slot').forEach(btn => {
        btn.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');

      // Enable next button
      document.getElementById('nextStep2').disabled = false;
    }

    // Go to step
    function goToStep(stepNum) {
      console.log("[v0] Going to step:", stepNum);

      if (stepNum === 2 && !bookingState.selectedGame) {
        showError('Please select a game first');
        return;
      }

      if (stepNum === 3) {
        if (!bookingState.selectedDate || !bookingState.selectedTimeSlot) {
          showError('Please select date and time slot');
          return;
        }
        displayConfirmation();
      }

      if (stepNum === 4) {
        displayPaymentSummary();
      }

      // Hide all steps
      document.querySelectorAll('.booking-step').forEach(step => {
        step.classList.remove('active');
      });

      // Show current step
      document.getElementById('step' + stepNum).classList.add('active');

      // Update step indicator
      updateStepIndicator(stepNum);

      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Update step indicator
    function updateStepIndicator(currentStep = 1) {
      for (let i = 1; i <= 4; i++) {
        const circle = document.getElementById('step' + i + 'Circle');
        circle.classList.remove('active', 'completed');
        if (i < currentStep) {
          circle.classList.add('completed');
        } else if (i === currentStep) {
          circle.classList.add('active');
        }
      }
    }

    // Display confirmation
    function displayConfirmation() {
      console.log("[v0] Displaying confirmation");
      const confirmationHTML = `
        <div class="confirmation-item">
          <span class="label">Game</span>
          <span class="value">${bookingState.selectedGame.name}</span>
        </div>
        <div class="confirmation-item">
          <span class="label">Date</span>
          <span class="value">${new Date(bookingState.selectedDate).toLocaleDateString('en-IN')}</span>
        </div>
        <div class="confirmation-item">
          <span class="label">Time Slot</span>
          <span class="value">${bookingState.selectedTimeSlot.startTime} - ${bookingState.selectedTimeSlot.endTime}</span>
        </div>
        <div class="confirmation-item">
          <span class="label">Price (per hour)</span>
          <span class="value">₹${bookingState.selectedGame.price_per_hour}</span>
        </div>
        <div class="confirmation-item">
          <span class="label">First Booking Discount</span>
          <span class="value" style="color: #4CAF50;">-₹${bookingState.selectedGame.first_booking_discount}</span>
        </div>
        <div class="price-breakdown">
          <div class="price-row">
            <span>Subtotal</span>
            <span>₹${bookingState.selectedGame.price_per_hour}</span>
          </div>
          <div class="price-row">
            <span>First Booking Discount</span>
            <span>-₹${bookingState.selectedGame.first_booking_discount}</span>
          </div>
          <div class="price-row">
            <span>Total Amount</span>
            <span>₹${bookingState.selectedGame.price_per_hour - bookingState.selectedGame.first_booking_discount}</span>
          </div>
        </div>
      `;
      document.getElementById('confirmationDetails').innerHTML = confirmationHTML;
    }

    // Display payment summary
    function displayPaymentSummary() {
      console.log("[v0] Displaying payment summary");
      const totalAmount = bookingState.selectedGame.price_per_hour - bookingState.selectedGame.first_booking_discount;
      
      const paymentHTML = `
        <div class="confirmation-item">
          <span class="label">Game</span>
          <span class="value">${bookingState.selectedGame.name}</span>
        </div>
        <div class="confirmation-item">
          <span class="label">Date & Time</span>
          <span class="value">${new Date(bookingState.selectedDate).toLocaleDateString('en-IN')} ${bookingState.selectedTimeSlot.startTime}</span>
        </div>
        <div class="price-breakdown">
          <div class="price-row">
            <span>Price</span>
            <span>₹${bookingState.selectedGame.price_per_hour}</span>
          </div>
          <div class="price-row">
            <span>First Booking Discount</span>
            <span>-₹${bookingState.selectedGame.first_booking_discount}</span>
          </div>
          <div class="price-row">
            <span style="font-size: 1.2rem;">Total Amount</span>
            <span style="font-size: 1.2rem;">₹${totalAmount}</span>
          </div>
        </div>
      `;
      document.getElementById('paymentSummary').innerHTML = paymentHTML;
    }

    // Initiate payment
    async function initiatePayment() {
      console.log("[v0] Initiating payment");
      try {
        // Create booking first
        const booking = await bookingManager.createBooking(
          bookingState.selectedGame.id,
          bookingState.selectedDate,
          bookingState.selectedTimeSlot.startTime,
          bookingState.selectedTimeSlot.endTime
        );

        console.log("[v0] Booking created:", booking);

        if (!booking || !booking.id) {
          throw new Error('Failed to create booking');
        }

        // Calculate total amount
        const totalAmount = bookingState.selectedGame.price_per_hour - bookingState.selectedGame.first_booking_discount;
        const user = authManager.getCurrentUser();

        // Open Razorpay checkout directly
        const options = {
          key: 'rzp_test_S88GHrybG0zjNZ',
          amount: totalAmount * 100, // in paise
          currency: 'INR',
          name: 'Cue Stories',
          description: `${bookingState.selectedGame.name} Booking`,
          prefill: {
            name: user.name,
            email: user.email,
            contact: user.phone,
          },
          handler: async function(response) {
            console.log('[v0] Payment successful:', response);
            // Update booking status in Supabase
            await fetch(
              `${SUPABASE_URL}/rest/v1/bookings?id=eq.${booking.id}`,
              {
                method: 'PATCH',
                headers: {
                  'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                  'apikey': SUPABASE_ANON_KEY,
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  payment_status: 'completed',
                  payment_id: response.razorpay_payment_id,
                  status: 'confirmed'
                }),
              }
            );
            
            // Send confirmation email via backend
            try {
              await fetch(`http://localhost:5000/api/bookings/${booking.id}/send-confirmation`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  email: user.email,
                  name: user.name,
                  game: bookingState.selectedGame.name,
                  date: bookingState.selectedDate,
                  time: bookingState.selectedTimeSlot.startTime
                })
              });
              console.log('[v0] Confirmation email sent');
            } catch (emailError) {
              console.log('[v0] Email sending failed:', emailError);
            }
            
            alert('Payment successful! Your booking is confirmed. Check your email for confirmation.');
            window.location.href = 'profile.html';
          },
          modal: {
            ondismiss: function() {
              console.log('[v0] Payment cancelled');
              showError('Payment was cancelled');
            }
          },
          theme: {
            color: '#ffc107'
          }
        };

        const rzp = new Razorpay(options);
        rzp.open();
      } catch (error) {
        console.error("[v0] Payment error:", error);
        showError('Failed to initiate payment: ' + error.message);
      }
    }

    // Show error
    function showError(message) {
      const errorBox = document.getElementById('errorBox');
      errorBox.textContent = message;
      errorBox.style.display = 'block';
      setTimeout(() => {
        errorBox.style.display = 'none';
      }, 5000);
    }
  </script>
</body>
</html>
